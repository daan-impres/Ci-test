<?xml version="1.0" encoding="UTF-8"?>
<project name="Ci-test" default="build" basedir="../">

    <property file="build/build.properties" />

    <!-- Sets the DSTAMP, TSTAMP and TODAY properties -->
    <tstamp/>

    <!-- Clean old build output -->
    <target name="clean">
        <delete dir="build/log" />
        <delete dir="api" />
    </target>

    <!-- Preparation create required directories -->
    <target name="prepare">
        <echo msg="Making directory build" />
        <mkdir dir="build" />
        <mkdir dir="build/log" />
        <mkdir dir="build/log/code-browser" />
        <mkdir dir="build/log/phpunit" />
        <mkdir dir="api" />
    </target>

    <!-- Run some tools on the sourcecode -->
    <target name="docblox">
        <docblox title="Api docs" destdir="api">
            <fileset dir="source/application">
                <include name="**/*.php" />
            </fileset>
        </docblox>
    </target>

    <target name="codesniffer">
        <phpcodesniffer
            standard="PEAR"
            file="source/application">
            <formatter type="checkstyle" outfile="build/log/checkstyle.xml"/>
        </phpcodesniffer>
    </target>

    <target name="phpcpd">
    <phpcpd>
        <fileset dir="source/application">
            <include name="**/*.php" />
        </fileset>
        <formatter type="pmd" outfile="build/log/pmd-cpd.xml"/>
    </phpcpd>
    </target>

    <target name="phpmd">
        <phpmd file="source/application"
            rulesets="rule">
            <formatter type="xml" outfile="build/log/pmd.xml" />
        </phpmd>
    </target>

    <target name="phpdepend">
        <phpdepend>
            <fileset dir="source/application">
                <include name="**/*.php"/>
            </fileset>
            <logger type="jdepend-xml" outfile="build/log/jdepend.xml" />
            <analyzer type="coderank-mode" value="method" />
        </phpdepend>
    </target>

    <target name="phploc" description="Measure project size using PHPLOC">
        <exec executable="phploc">
            <arg value="--log-csv" />
            <arg value="build/log/phploc.csv" />
            <arg path="./" />
        </exec>
    </target>

    <target name="phpcb"
        description="Aggregate tool output with PHP_CodeBrowser">
        <exec executable="phpcb">
            <arg value="--log" />
            <arg path="build/log" />
            <arg value="--source" />
            <arg path="source/application" />
            <arg value="--output" />
            <arg path="build/log/code-browser" />
        </exec>
    </target>

    <!-- PHPUnit task run unit tests (binary is called phpunit34 because an older version is required for Zend Framework) -->
    <target name="phpunit">
        <exec executable="phpunit34" dir="source/tests">
        </exec>
    </target>

    <target name="build" depends="clean, prepare, docblox, codesniffer, phpcpd, phpdepend, phploc, phpcb, phpunit" />
</project>
